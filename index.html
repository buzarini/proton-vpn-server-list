<!DOCTYPE html>
<html lang="ru" data-bs-theme="dark">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="referrer" content="no-referrer">
    <meta name="description" content="–ò–Ω—Ç–µ—Ä–∞–∫—Ç–∏–≤–Ω–∞—è –∫–∞—Ä—Ç–∞ –∏ —Å–ø–∏—Å–æ–∫ —Å–µ—Ä–≤–µ—Ä–æ–≤ ProtonVPN —Å –ø–æ–¥–¥–µ—Ä–∂–∫–æ–π IPv6 –∏ —Ñ–∏–ª—å—Ç—Ä–∞—Ü–∏–µ–π">
    <meta http-equiv="Content-Security-Policy" content="
        default-src 'self' https://github.com; 
        script-src 'self' https://cdn.jsdelivr.net https://unpkg.com https://api.cors.lol 'unsafe-inline' https://cdn.datatables.net; 
        style-src 'self' https://cdn.jsdelivr.net https://unpkg.com 'unsafe-inline' https://cdn.datatables.net; 
        img-src 'self' data: https://tile.openstreetmap.org https://unpkg.com; 
        connect-src 'self' https://api.cors.lol https://api.protonmail.ch https://protonvpnmapproxy.privacyjam.com https://raw.githubusercontent.com https://cdn.datatables.net; 
        object-src 'none';">
    <meta http-equiv="Strict-Transport-Security" content="max-age=31536000; includeSubDomains; preload">
    <meta http-equiv="X-Content-Type-Options" content="nosniff">

    <title>ProtonVPN - –ò–Ω—Ç–µ—Ä–∞–∫—Ç–∏–≤–Ω–∞—è –∫–∞—Ä—Ç–∞ –∏ —Å–ø–∏—Å–æ–∫ —Å–µ—Ä–≤–µ—Ä–æ–≤</title>
    
    <!-- –û—Å–Ω–æ–≤–Ω—ã–µ —Å—Ç–∏–ª–∏ -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css">
    <link rel="stylesheet" href="https://cdn.datatables.net/2.2.0/css/dataTables.bootstrap5.min.css"/>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" crossorigin="anonymous">
    <link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster/dist/MarkerCluster.css" crossorigin="anonymous">
    <link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster/dist/MarkerCluster.Default.css" crossorigin="anonymous">

    <style>
        :root {
            --cluster-small: #8bc34a;
            --cluster-medium: #ffc107;
            --cluster-large: #f44336;
            --tor-color: #9c27b0;
            --secure-core-color: #ff9800;
            --smart-routing-color: #f44336;
        }
        
        #map { 
            height: 60vh; 
            width: 100%; 
            margin-bottom: 20px;
            border-radius: 8px;
            transition: opacity 0.3s ease;
        }
        
        .map-loading {
            opacity: 0.7;
        }
        
        .popup-content {
            max-height: 200px;
            overflow-y: auto;
            width: 320px;
        }
        
        #loading {
            position: absolute;
            top: 10px;
            left: 50%;
            transform: translateX(-50%);
            background: rgba(0, 0, 0, 0.7);
            color: white;
            padding: 8px 12px;
            border-radius: 5px;
            font-size: 14px;
            z-index: 1000;
            display: flex;
            align-items: center;
        }
        
        .spinner-border {
            margin-right: 8px;
        }
        
        .github-link {
            position: fixed;
            bottom: 40px;
            left: 20px;
            font-size: 14px;
            background: rgba(0, 0, 0, 0.8);
            padding: 8px 12px;
            border-radius: 8px;
            z-index: 1100;
            transition: transform 0.2s ease;
        }
        
        .github-link:hover {
            transform: scale(1.05);
        }
        
        .github-link a {
            color: white;
            text-decoration: none;
            font-weight: bold;
            display: flex;
            align-items: center;
        }
        
        .nav-tabs {
            margin-bottom: 20px;
        }
        
        .tab-content {
            padding: 15px;
            border-left: 1px solid #444;
            border-right: 1px solid #444;
            border-bottom: 1px solid #444;
            border-radius: 0 0 8px 8px;
        }
        
        .last-update {
            position: fixed;
            top: 0;
            left: 0;
            background: rgba(0, 0, 0, 0.7);
            padding: 5px 10px;
            border-radius: 0 0 5px 0;
            z-index: 1000;
            font-size: 12px;
        }
        
        .filter-container {
            margin-bottom: 15px;
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
            align-items: center;
        }
        
        .filter-badge {
            cursor: pointer;
            transition: all 0.2s ease;
        }
        
        .filter-badge.active {
            transform: scale(1.1);
            box-shadow: 0 0 0 2px rgba(255,255,255,0.3);
        }
        
        .badge-tor {
            background-color: var(--tor-color);
        }
        
        .badge-secure-core {
            background-color: var(--secure-core-color);
        }
        
        .badge-smart-routing {
            background-color: var(--smart-routing-color);
        }
        
        .marker-cluster-small {
            background-color: rgba(139, 195, 74, 0.6);
        }
        
        .marker-cluster-small div {
            background-color: var(--cluster-small);
        }
        
        .marker-cluster-medium {
            background-color: rgba(255, 193, 7, 0.6);
        }
        
        .marker-cluster-medium div {
            background-color: var(--cluster-medium);
        }
        
        .marker-cluster-large {
            background-color: rgba(244, 67, 54, 0.6);
        }
        
        .marker-cluster-large div {
            background-color: var(--cluster-large);
        }
        
        .copy-ip {
            cursor: pointer;
            margin-left: 5px;
            opacity: 0.7;
            transition: opacity 0.2s ease;
        }
        
        .copy-ip:hover {
            opacity: 1;
        }

        /* –ù–æ–≤—ã–µ —Å—Ç–∏–ª–∏ –¥–ª—è –¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã—Ö —Ñ—É–Ω–∫—Ü–∏–π */
        #load-chart {
            width: 100%;
            height: 300px;
            margin-bottom: 20px;
        }
        
        .export-buttons {
            margin-bottom: 15px;
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
        }
        
        #chart-container {
            display: none;
            margin-bottom: 20px;
            border: 1px solid #444;
            border-radius: 8px;
            padding: 15px;
            background: rgba(0, 0, 0, 0.2);
        }
        
        @media (max-width: 768px) {
            #map {
                height: 50vh;
            }
            
            .github-link {
                bottom: 20px;
                left: 10px;
                font-size: 12px;
            }
            
            .export-buttons {
                flex-direction: column;
            }
        }
    </style>
</head>
<body>
    <div class="container-fluid mt-3">
        <h1 class="text-center mb-4">ProtonVPN - –ò–Ω—Ç–µ—Ä–∞–∫—Ç–∏–≤–Ω–∞—è –∫–∞—Ä—Ç–∞ —Å–µ—Ä–≤–µ—Ä–æ–≤</h1>
        
        <ul class="nav nav-tabs" id="myTab" role="tablist">
            <li class="nav-item" role="presentation">
                <button class="nav-link active" id="map-tab" data-bs-toggle="tab" data-bs-target="#map-tab-pane" type="button" role="tab">
                    –ö–∞—Ä—Ç–∞ —Å–µ—Ä–≤–µ—Ä–æ–≤
                </button>
            </li>
            <li class="nav-item" role="presentation">
                <button class="nav-link" id="list-tab" data-bs-toggle="tab" data-bs-target="#list-tab-pane" type="button" role="tab">
                    –°–ø–∏—Å–æ–∫ —Å–µ—Ä–≤–µ—Ä–æ–≤
                </button>
            </li>
        </ul>
        
        <div class="tab-content" id="myTabContent">
            <div class="tab-pane fade show active" id="map-tab-pane" role="tabpanel" tabindex="0">
                <div class="filter-container">
                    <span class="me-2">–§–∏–ª—å—Ç—Ä—ã:</span>
                    <span class="badge filter-badge active" data-filter="all">–í—Å–µ</span>
                    <span class="badge filter-badge badge-tor" data-filter="tor">TOR</span>
                    <span class="badge filter-badge badge-secure-core" data-filter="secure-core">Secure Core</span>
                    <span class="badge filter-badge badge-smart-routing" data-filter="smart-routing">Smart Routing</span>
                    <button class="btn btn-sm btn-outline-info ms-auto" id="show-chart-btn">–ü–æ–∫–∞–∑–∞—Ç—å –≥—Ä–∞—Ñ–∏–∫ –Ω–∞–≥—Ä—É–∑–∫–∏</button>
                </div>
                <div id="chart-container">
                    <canvas id="load-chart"></canvas>
                </div>
                <div id="map" class="map-loading"></div>
                <div id="loading">
                    <div class="spinner-border spinner-border-sm" role="status"></div>
                    –ó–∞–≥—Ä—É–∑–∫–∞ –¥–∞–Ω–Ω—ã—Ö –æ —Å–µ—Ä–≤–µ—Ä–∞—Ö...
                </div>
            </div>
            
            <div class="tab-pane fade" id="list-tab-pane" role="tabpanel" tabindex="0">
                <div class="filter-container">
                    <span class="me-2">–§–∏–ª—å—Ç—Ä—ã:</span>
                    <span class="badge filter-badge active" data-filter="all">–í—Å–µ</span>
                    <span class="badge filter-badge badge-tor" data-filter="tor">TOR</span>
                    <span class="badge filter-badge badge-secure-core" data-filter="secure-core">Secure Core</span>
                    <span class="badge filter-badge badge-smart-routing" data-filter="smart-routing">Smart Routing</span>
                    <span class="badge filter-badge" data-filter="ipv6">IPv6</span>
                </div>
                <div class="export-buttons">
                    <button id="export-csv" class="btn btn-sm btn-outline-secondary">–≠–∫—Å–ø–æ—Ä—Ç CSV</button>
                    <button id="export-json" class="btn btn-sm btn-outline-secondary">–≠–∫—Å–ø–æ—Ä—Ç JSON</button>
                    <button id="find-nearest" class="btn btn-sm btn-outline-primary">–ù–∞–π—Ç–∏ –±–ª–∏–∂–∞–π—à–∏–π —Å–µ—Ä–≤–µ—Ä</button>
                </div>
                <table id="server-table" class="table table-striped table-hover table-responsive table-sm">
                    <thead>
                        <tr>
                            <th>–£–∑–µ–ª</th>
                            <th>–°–µ—Ä–≤–µ—Ä</th>
                            <th>–í—Ö–æ–¥–Ω–æ–π IPv4</th>
                            <th>–í—ã—Ö–æ–¥–Ω–æ–π IPv4</th>
                            <th>–í—Ö–æ–¥–Ω–æ–π IPv6</th>
                            <th>–í—ã—Ö–æ–¥–Ω–æ–π IPv6</th>
                            <th>–ü—Ä–æ–≤–∞–π–¥–µ—Ä</th>
                            <th>–ù–∞–≥—Ä—É–∑–∫–∞</th>
                            <th>–¢–∏–ø</th>
                        </tr>
                    </thead>
                    <tbody></tbody>
                </table>
            </div>
        </div>
    </div>
    
    <div class="github-link">
        <a href="https://github.com/privacyjam/Proton-Vpn-Server-Map" target="_blank" rel="noopener noreferrer">
            –ò—Å—Ö–æ–¥–Ω—ã–π –∫–æ–¥
        </a>
    </div>
    
    <div class="last-update">–ü–æ—Å–ª–µ–¥–Ω–µ–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ: <span id="update-date">2025-02-26</span></div>

    <!-- –°–∫—Ä–∏–ø—Ç—ã -->
    <script src="https://cdn.jsdelivr.net/npm/jquery@3.7.1/dist/jquery.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://cdn.datatables.net/2.1.8/js/dataTables.js"></script>
    <script src="https://cdn.datatables.net/2.2.0/js/dataTables.bootstrap5.min.js"></script>
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js" crossorigin="anonymous"></script>
    <script src="https://unpkg.com/leaflet.markercluster/dist/leaflet.markercluster.js" crossorigin="anonymous"></script>
    <script src="https://cdn.jsdelivr.net/npm/jquery-csv@1.0.40/src/jquery.csv.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>

    <script>
        // –ì–ª–æ–±–∞–ª—å–Ω—ã–µ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ
        let map, markerCluster, serverMarkers = [], serverTable, allServersData = [];
        const MSG_UNKNOWN_IPV6 = ":: (–ï—Å—Ç—å, –Ω–æ –Ω–µ–∏–∑–≤–µ—Å—Ç–µ–Ω)";
        let L = null; // –î–ª—è –ª–µ–Ω–∏–≤–æ–π –∑–∞–≥—Ä—É–∑–∫–∏ Leaflet
        let Chart = null; // –î–ª—è –ª–µ–Ω–∏–≤–æ–π –∑–∞–≥—Ä—É–∑–∫–∏ Chart.js
        
        // –õ–æ–∫–∞–ª–∏–∑–∞—Ü–∏—è DataTables –Ω–∞ —Ä—É—Å—Å–∫–∏–π
        const russianLanguage = {
            "decimal":        "",
            "emptyTable":     "–ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö –≤ —Ç–∞–±–ª–∏—Ü–µ",
            "info":           "–ü–æ–∫–∞–∑–∞–Ω–æ —Å _START_ –ø–æ _END_ –∏–∑ _TOTAL_ –∑–∞–ø–∏—Å–µ–π",
            "infoEmpty":      "–ü–æ–∫–∞–∑–∞–Ω–æ —Å 0 –ø–æ 0 –∏–∑ 0 –∑–∞–ø–∏—Å–µ–π",
            "infoFiltered":   "(–æ—Ç—Ñ–∏–ª—å—Ç—Ä–æ–≤–∞–Ω–æ –∏–∑ _MAX_ –∑–∞–ø–∏—Å–µ–π)",
            "infoPostFix":    "",
            "thousands":      ",",
            "lengthMenu":     "–ü–æ–∫–∞–∑–∞—Ç—å _MENU_ –∑–∞–ø–∏—Å–µ–π",
            "loadingRecords": "–ó–∞–≥—Ä—É–∑–∫–∞...",
            "processing":     "–û–±—Ä–∞–±–æ—Ç–∫–∞...",
            "search":         "–ü–æ–∏—Å–∫:",
            "zeroRecords":    "–°–æ–≤–ø–∞–¥–µ–Ω–∏–π –Ω–µ –Ω–∞–π–¥–µ–Ω–æ",
            "paginate": {
                "first":      "–ü–µ—Ä–≤–∞—è",
                "last":       "–ü–æ—Å–ª–µ–¥–Ω—è—è",
                "next":       "–°–ª–µ–¥—É—é—â–∞—è",
                "previous":   "–ü—Ä–µ–¥—ã–¥—É—â–∞—è"
            },
            "aria": {
                "sortAscending":  ": –∞–∫—Ç–∏–≤–∏—Ä–æ–≤–∞—Ç—å –¥–ª—è —Å–æ—Ä—Ç–∏—Ä–æ–≤–∫–∏ –ø–æ –≤–æ–∑—Ä–∞—Å—Ç–∞–Ω–∏—é",
                "sortDescending": ": –∞–∫—Ç–∏–≤–∏—Ä–æ–≤–∞—Ç—å –¥–ª—è —Å–æ—Ä—Ç–∏—Ä–æ–≤–∫–∏ –ø–æ —É–±—ã–≤–∞–Ω–∏—é"
            }
        };
        
        // –ò–∫–æ–Ω–∫–∞ –º–∞—Ä–∫–µ—Ä–∞
        function getDefaultIcon() {
            return L.icon({
                iconUrl: 'https://unpkg.com/leaflet@1.9.4/dist/images/marker-icon.png',
                shadowUrl: 'https://unpkg.com/leaflet@1.9.4/dist/images/marker-shadow.png',
                iconSize: [25, 41],
                iconAnchor: [12, 41],
                popupAnchor: [1, -34],
                shadowSize: [41, 41]
            });
        }

        // ======================
        // –û—Å–Ω–æ–≤–Ω—ã–µ —Ñ—É–Ω–∫—Ü–∏–∏
        // ======================

        $(document).ready(async function() {
            // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –≤–∫–ª–∞–¥–æ–∫ —Å –ª–µ–Ω–∏–≤–æ–π –∑–∞–≥—Ä—É–∑–∫–æ–π
            $('button[data-bs-toggle="tab"]').on('shown.bs.tab', lazyLoadMap);
            
            // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è —Ñ–∏–ª—å—Ç—Ä–æ–≤
            $('.filter-badge').on('click', function() {
                const filter = $(this).data('filter');
                $('.filter-badge').removeClass('active');
                $(this).addClass('active');
                
                if (window.mapInitialized) {
                    optimizedFilterMarkers(filter);
                }
                
                if (serverTable) {
                    filterTable(filter);
                }
            });

            // –ó–∞–≥—Ä—É–∂–∞–µ–º –¥–∞–Ω–Ω—ã–µ —Å –∫—ç—à–∏—Ä–æ–≤–∞–Ω–∏–µ–º
            await loadServerDataWithCache();
            
            // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã—Ö —Ñ—É–Ω–∫—Ü–∏–π
            setupExportButtons();
            setupNearestServerFinder();
            setupChartButton();
            
            // –õ–µ–Ω–∏–≤–∞—è –∑–∞–≥—Ä—É–∑–∫–∞ –∫–∞—Ä—Ç—ã, –µ—Å–ª–∏ –∞–∫—Ç–∏–≤–Ω–∞ —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤—É—é—â–∞—è –≤–∫–ª–∞–¥–∫–∞
            lazyLoadMap();
        });

        // ======================
        // –û–ø—Ç–∏–º–∏–∑–∞—Ü–∏–∏ –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç–∏
        // ======================

        // 1. –õ–µ–Ω–∏–≤–∞—è –∑–∞–≥—Ä—É–∑–∫–∞ –∫–∞—Ä—Ç—ã
        async function lazyLoadMap() {
            if (!window.mapInitialized && $('#map-tab').hasClass('active')) {
                try {
                    $('#loading').show();
                    
                    // –î–∏–Ω–∞–º–∏—á–µ—Å–∫–∏ –∑–∞–≥—Ä—É–∂–∞–µ–º Leaflet —Ç–æ–ª—å–∫–æ –∫–æ–≥–¥–∞ –Ω—É–∂–µ–Ω
                    if (!L) {
                        const leafletModule = await import('https://unpkg.com/leaflet@1.9.4/dist/leaflet-src.esm.js');
                        L = leafletModule.default;
                    }
                    
                    initMap();
                    window.mapInitialized = true;
                    $('#loading').hide();
                } catch (error) {
                    console.error("–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –∫–∞—Ä—Ç—ã:", error);
                    $('#loading').hide();
                    showError("–ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–≥—Ä—É–∑–∏—Ç—å –∫–∞—Ä—Ç—É");
                }
            }
        }

        // 2. –ö—ç—à–∏—Ä–æ–≤–∞–Ω–∏–µ –¥–∞–Ω–Ω—ã—Ö
        async function loadServerDataWithCache() {
            const CACHE_KEY = "protonvpn-servers-cache";
            const CACHE_DURATION = 3600 * 1000; // 1 —á–∞—Å
            
            try {
                const cached = localStorage.getItem(CACHE_KEY);
                if (cached) {
                    const { data, timestamp } = JSON.parse(cached);
                    if (Date.now() - timestamp < CACHE_DURATION) {
                        allServersData = data;
                        initServerTable();
                        checkServerChanges(data);
                        return;
                    }
                }
                
                const data = await fetchServerData();
                localStorage.setItem(CACHE_KEY, JSON.stringify({
                    data: data,
                    timestamp: Date.now()
                }));
                allServersData = data;
                initServerTable();
                checkServerChanges(data);
                
                // –û–±–Ω–æ–≤–ª—è–µ–º –¥–∞—Ç—É –ø–æ—Å–ª–µ–¥–Ω–µ–≥–æ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è
                $('#update-date').text(new Date().toISOString().split('T')[0]);
            } catch (error) {
                console.error("–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –¥–∞–Ω–Ω—ã—Ö:", error);
                showError("–ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–≥—Ä—É–∑–∏—Ç—å –¥–∞–Ω–Ω—ã–µ –æ —Å–µ—Ä–≤–µ—Ä–∞—Ö. –ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –ø–æ–ø—Ä–æ–±—É–π—Ç–µ –ø–æ–∑–∂–µ.");
            }
        }

        async function fetchServerData() {
            const [logicalsRes, nodesIpv6Res, ipinfoRes] = await Promise.all([
                fetchWithRetry("logicals.json?2025-01-21"),
                fetchWithRetry("nodes-ipv6.json?2025-01-21"),
                fetchWithRetry("ipinfo.csv?2025-01-21")
            ]);
            
            const [logicalsJson, nodesIpv6, ipinfoText] = await Promise.all([
                logicalsRes.json(),
                nodesIpv6Res.json(),
                ipinfoRes.text()
            ]);
            
            const logicals = logicalsJson.LogicalServers;
            const ipinfo = $.csv.toObjects(ipinfoText);
            const serversData = [];

            logicals.filter(l => l.Servers.length === 1).forEach(logical => {
                const isp = ipinfo.find(i => i.ip === logical.Servers[0].ExitIP);
                const hasIpv6 = !!(16 & logical.Features);
                const isTor = logical.Name.includes("TOR");
                const isSecureCore = logical.Features === 1;
                const isSmartRouting = logical.HostCountry && logical.HostCountry !== logical.EntryCountry;
                
                const serverData = {
                    domain: logical.Domain,
                    name: logical.Name,
                    entryIpv4: logical.Servers[0].EntryIP,
                    exitIpv4: logical.Servers[0].ExitIP,
                    entryIpv6: nodesIpv6[logical.Domain] || (hasIpv6 ? MSG_UNKNOWN_IPV6 : ""),
                    exitIpv6: "",
                    provider: isp ? isp.org : "",
                    load: logical.Load || 0,
                    type: isTor ? "tor" : isSecureCore ? "secure-core" : isSmartRouting ? "smart-routing" : "regular",
                    lat: logical.Location?.Lat,
                    lon: logical.Location?.Long,
                    city: logical.City,
                    country: logical.EntryCountry,
                    hostCountry: logical.HostCountry
                };
                
                serversData.push(serverData);
            });

            // –ü—Ä–µ–¥–ø–æ–ª–∞–≥–∞–µ–º –≤—ã—Ö–æ–¥–Ω—ã–µ IPv6 –∞–¥—Ä–µ—Å–∞
            const hasIpv6 = serversData.filter(l => l.entryIpv6 && l.entryIpv6 !== MSG_UNKNOWN_IPV6);
            hasIpv6.sort((a, b) => Number(a.name.split("#")[1]) - Number(b.name.split("#")[1]));

            Object.entries(Object.groupBy(hasIpv6, d => d.domain)).forEach(([_, node]) => {
                const parts = node[0].entryIpv6.split("::");
                const prefix = parts[0];
                let suffixInt = parseInt(parts[1], 16);

                // –ò—Å–ø—Ä–∞–≤–ª–µ–Ω–∏—è –¥–ª—è —Å–ø–µ—Ü–∏—Ñ–∏—á–µ—Å–∫–∏—Ö —Å–ª—É—á–∞–µ–≤
                if (suffixInt === 17) suffixInt = 16;
                if (suffixInt === 13) suffixInt = 32;
                
                node.forEach(server => {
                    suffixInt++;
                    server.exitIpv6 = `${prefix}::${suffixInt.toString(16)}`;
                });
            });

            return serversData;
        }

        // 3. –û–ø—Ç–∏–º–∏–∑–∏—Ä–æ–≤–∞–Ω–Ω–∞—è —Ñ–∏–ª—å—Ç—Ä–∞—Ü–∏—è –º–∞—Ä–∫–µ—Ä–æ–≤
        function optimizedFilterMarkers(filter) {
            requestAnimationFrame(() => {
                markerCluster.clearLayers();
                const filtered = filter === 'all' 
                    ? allServersData 
                    : allServersData.filter(server => {
                        if (filter === 'tor') return server.type === 'tor';
                        if (filter === 'secure-core') return server.type === 'secure-core';
                        if (filter === 'smart-routing') return server.type === 'smart-routing';
                        return true;
                    });
                createMarkers(filtered.filter(s => s.lat && s.lon));
            });
        }

        function initMap() {
            // –ü—Ä–æ–≤–µ—Ä—è–µ–º, –Ω–µ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω–∞ –ª–∏ –∫–∞—Ä—Ç–∞ —É–∂–µ
            if (map) {
                map.remove();
            }
            
            map = L.map('map', { 
                center: [20, 0], 
                zoom: 2, 
                zoomSnap: 0.5
            });
    
            L.tileLayer('https://tile.openstreetmap.org/{z}/{x}/{y}.png', {
                maxZoom: 19,
                attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a>'
            }).addTo(map);
    
            markerCluster = L.markerClusterGroup({
                maxClusterRadius: 20,
                disableClusteringAtZoom: 8,
                iconCreateFunction: (cluster) => {
                    const childCount = cluster.getChildCount();
                    let clusterClass = 'marker-cluster-small';
                    if (childCount > 10) clusterClass = 'marker-cluster-medium';
                    if (childCount > 50) clusterClass = 'marker-cluster-large';
                    return new L.DivIcon({
                        html: `<div><span>${childCount}</span></div>`,
                        className: `marker-cluster ${clusterClass}`,
                        iconSize: [30, 30],
                    });
                },
            });            
            
            // –°–æ–∑–¥–∞–µ–º –º–∞—Ä–∫–µ—Ä—ã –¥–ª—è –≤—Å–µ—Ö —Å–µ—Ä–≤–µ—Ä–æ–≤
            createMarkers(allServersData);
            
            // –î–æ–±–∞–≤–ª—è–µ–º –∫–ª–∞—Å—Ç–µ—Ä –Ω–∞ –∫–∞—Ä—Ç—É
            map.addLayer(markerCluster);
            
            // –£–±–∏—Ä–∞–µ–º –∏–Ω–¥–∏–∫–∞—Ç–æ—Ä –∑–∞–≥—Ä—É–∑–∫–∏
            document.getElementById("map").classList.remove("map-loading");
        }
        
        function createMarkers(servers) {
            // –û—á–∏—â–∞–µ–º –ø—Ä–µ–¥—ã–¥—É—â–∏–µ –º–∞—Ä–∫–µ—Ä—ã
            serverMarkers = [];
            
            const locationGroups = {};
            
            servers.forEach(server => {
                const key = `${server.lat.toFixed(2)},${server.lon.toFixed(2)}`;
                if (!locationGroups[key]) {
                    locationGroups[key] = [];
                }
                locationGroups[key].push(server);
            });
            
            Object.entries(locationGroups).forEach(([key, servers]) => {
                const [lat, lon] = key.split(',').map(Number);
                const locationName = servers[0].city || servers[0].country;
    
                let popupContent = `<b>${locationName}</b><br>`;
                popupContent += `<b>${servers.length} —Å–µ—Ä–≤–µ—Ä–æ–≤</b><br><div class="popup-content">`;
    
                servers.forEach(server => {
                    let smartRouting = server.hostCountry && server.hostCountry !== server.country 
                        ? `<span style="color:var(--smart-routing-color); font-weight:bold;">(Smart Routing –∏–∑ ${server.hostCountry})</span>` 
                        : '';
    
                    let torServer = server.type === 'tor'
                        ? `<span style="color:var(--tor-color); font-weight:bold;">(TOR —Å–µ—Ä–≤–µ—Ä)</span>` 
                        : '';
                    
                    let secureCore = server.type === 'secure-core'
                        ? `<span style="color:var(--secure-core-color); font-weight:bold;">(Secure Core${server.country !== server.hostCountry ? ` –∏–∑ ${server.country}` : ''})</span>` 
                        : '';
                    
                    popupContent += `üîπ <b>${server.name}</b> - –ù–∞–≥—Ä—É–∑–∫–∞: ${server.load}% ${smartRouting} ${torServer} ${secureCore}<br>`;
                });
    
                popupContent += `</div>`;
    
                const marker = L.marker([lat, lon], { 
                    icon: getDefaultIcon(),
                    serverType: servers[0].type
                }).bindPopup(popupContent, { maxWidth: 350 });
                
                serverMarkers.push(marker);
                markerCluster.addLayer(marker);
            });
        }

        function initServerTable() {
            serverTable = $('#server-table').DataTable({
                data: allServersData.map(server => [
                    server.domain,
                    server.name,
                    `<span class="ip-address">${server.entryIpv4}</span><span class="copy-ip" title="–ö–æ–ø–∏—Ä–æ–≤–∞—Ç—å" data-ip="${server.entryIpv4}">‚éò</span>`,
                    `<span class="ip-address">${server.exitIpv4}</span><span class="copy-ip" title="–ö–æ–ø–∏—Ä–æ–≤–∞—Ç—å" data-ip="${server.exitIpv4}">‚éò</span>`,
                    server.entryIpv6 ? `<span class="ip-address">${server.entryIpv6}</span><span class="copy-ip" title="–ö–æ–ø–∏—Ä–æ–≤–∞—Ç—å" data-ip="${server.entryIpv6}">‚éò</span>` : '',
                    server.exitIpv6 ? `<span class="ip-address">${server.exitIpv6}</span><span class="copy-ip" title="–ö–æ–ø–∏—Ä–æ–≤–∞—Ç—å" data-ip="${server.exitIpv6}">‚éò</span>` : '',
                    server.provider,
                    server.load + '%',
                    server.type === 'tor' ? 'TOR' : server.type === 'secure-core' ? 'Secure Core' : server.type === 'smart-routing' ? 'Smart Routing' : '–û–±—ã—á–Ω—ã–π'
                ]),
                pageLength: 25,
                language: russianLanguage,
                search: {
                    search: '::'
                },
                columns: [
                    { data: 0 },
                    { data: 1 },
                    { data: 2 },
                    { data: 3 },
                    { data: 4 },
                    { data: 5 },
                    { data: 6 },
                    { data: 7, type: 'num' },
                    { data: 8 }
                ],
                initComplete: function() {
                    // –û–±—Ä–∞–±–æ—Ç–∫–∞ –∫–æ–ø–∏—Ä–æ–≤–∞–Ω–∏—è IP-–∞–¥—Ä–µ—Å–æ–≤
                    $('#server-table').on('click', '.copy-ip', function(e) {
                        e.stopPropagation();
                        const ip = $(this).data('ip');
                        navigator.clipboard.writeText(ip).then(() => {
                            $(this).text('‚úì');
                            setTimeout(() => $(this).text('‚éò'), 1000);
                        });
                    });
                }
            });
        }
        
        function filterTable(filter) {
            if (filter === 'all') {
                serverTable.search('').columns().search('').draw();
            } else if (filter === 'ipv6') {
                serverTable.columns(4).search('::', true, false).draw();
            } else {
                serverTable.columns(8).search(filter === 'tor' ? 'TOR' : 
                                           filter === 'secure-core' ? 'Secure Core' : 
                                           filter === 'smart-routing' ? 'Smart Routing' : '').draw();
            }
        }

        // ======================
        // –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ —Ñ—É–Ω–∫—Ü–∏–∏
        // ======================

        // 1. –≠–∫—Å–ø–æ—Ä—Ç –¥–∞–Ω–Ω—ã—Ö
        function setupExportButtons() {
            $('#export-csv').click(() => {
                const csv = $.csv.fromObjects(allServersData);
                downloadFile(csv, 'protonvpn-servers.csv', 'text/csv');
            });
            
            $('#export-json').click(() => {
                const json = JSON.stringify(allServersData, null, 2);
                downloadFile(json, 'protonvpn-servers.json', 'application/json');
            });
        }

        function downloadFile(content, filename, type) {
            const blob = new Blob([content], { type });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = filename;
            a.click();
            URL.revokeObjectURL(url);
        }

        // 2. –ü–æ–∏—Å–∫ –±–ª–∏–∂–∞–π—à–µ–≥–æ —Å–µ—Ä–≤–µ—Ä–∞
        function setupNearestServerFinder() {
            $('#find-nearest').click(() => {
                if (!navigator.geolocation) {
                    showError("–ì–µ–æ–ª–æ–∫–∞—Ü–∏—è –Ω–µ –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç—Å—è –≤–∞—à–∏–º –±—Ä–∞—É–∑–µ—Ä–æ–º");
                    return;
                }
                
                $('#loading').show().text("–û–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ –≤–∞—à–µ–≥–æ –º–µ—Å—Ç–æ–ø–æ–ª–æ–∂–µ–Ω–∏—è...");
                navigator.geolocation.getCurrentPosition(
                    position => {
                        const { latitude, longitude } = position.coords;
                        findAndHighlightNearestServer(latitude, longitude);
                        $('#loading').hide();
                    },
                    error => {
                        showError("–ù–µ —É–¥–∞–ª–æ—Å—å –æ–ø—Ä–µ–¥–µ–ª–∏—Ç—å –º–µ—Å—Ç–æ–ø–æ–ª–æ–∂–µ–Ω–∏–µ: " + error.message);
                        $('#loading').hide();
                    },
                    { timeout: 10000 }
                );
            });
        }

        function findAndHighlightNearestServer(lat, lng) {
            if (!allServersData.length || !map || !L) return;
            
            let closest = null;
            let minDistance = Infinity;
            
            allServersData.forEach(server => {
                if (!server.lat || !server.lon) return;
                
                const distance = Math.hypot(
                    server.lat - lat,
                    server.lon - lng
                );
                
                if (distance < minDistance) {
                    minDistance = distance;
                    closest = server;
                }
            });
            
            if (closest) {
                map.flyTo([closest.lat, closest.lon], 8);
                L.popup()
                    .setLatLng([closest.lat, closest.lon])
                    .setContent(`–ë–ª–∏–∂–∞–π—à–∏–π —Å–µ—Ä–≤–µ—Ä: ${closest.name}<br>–†–∞—Å—Å—Ç–æ—è–Ω–∏–µ: ~${Math.round(minDistance * 100)} –∫–º`)
                    .openOn(map);
            }
        }

        // 3. –ü—Ä–æ–≤–µ—Ä–∫–∞ –∏–∑–º–µ–Ω–µ–Ω–∏–π —Å–µ—Ä–≤–µ—Ä–æ–≤
        function checkServerChanges(newData) {
            const oldData = JSON.parse(localStorage.getItem("prev-servers") || "[]");
            if (!oldData.length) {
                localStorage.setItem("prev-servers", JSON.stringify(newData));
                return;
            }
            
            const added = newData.filter(s => !oldData.some(o => o.domain === s.domain));
            const removed = oldData.filter(o => !newData.some(s => s.domain === o.domain));
            
            if (added.length || removed.length) {
                Swal.fire({
                    title: "–û–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Å–µ—Ä–≤–µ—Ä–æ–≤",
                    html: `–î–æ–±–∞–≤–ª–µ–Ω–æ: ${added.length} —Å–µ—Ä–≤–µ—Ä–æ–≤<br>–£–¥–∞–ª–µ–Ω–æ: ${removed.length} —Å–µ—Ä–≤–µ—Ä–æ–≤`,
                    icon: "info",
                    confirmButtonText: 'OK'
                });
            }
            
            localStorage.setItem("prev-servers", JSON.stringify(newData));
        }

        // 4. –ì—Ä–∞—Ñ–∏–∫ –Ω–∞–≥—Ä—É–∑–∫–∏
        function setupChartButton() {
            $('#show-chart-btn').click(async function() {
                $('#chart-container').toggle();
                
                if ($('#chart-container').is(':visible') && !window.chartInitialized) {
                    try {
                        // –î–∏–Ω–∞–º–∏—á–µ—Å–∫–∏ –∑–∞–≥—Ä—É–∂–∞–µ–º Chart.js —Ç–æ–ª—å–∫–æ –∫–æ–≥–¥–∞ –Ω—É–∂–µ–Ω
                        const ChartJS = await import('https://cdn.jsdelivr.net/npm/chart.js');
                        Chart = ChartJS.default;
                        renderLoadChart();
                        window.chartInitialized = true;
                    } catch (error) {
                        console.error("–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ Chart.js:", error);
                        showError("–ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–≥—Ä—É–∑–∏—Ç—å –≥—Ä–∞—Ñ–∏–∫");
                    }
                }
            });
        }

        function renderLoadChart() {
            if (!Chart || !allServersData.length) return;
            
            const ctx = document.getElementById('load-chart').getContext('2d');
            const countries = [...new Set(allServersData.map(s => s.country))];
            const avgLoad = countries.map(country => {
                const servers = allServersData.filter(s => s.country === country);
                return servers.reduce((sum, s) => sum + s.load, 0) / servers.length;
            });

            new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: countries,
                    datasets: [{
                        label: '–°—Ä–µ–¥–Ω—è—è –Ω–∞–≥—Ä—É–∑–∫–∞ (%)',
                        data: avgLoad,
                        backgroundColor: 'rgba(75, 192, 192, 0.6)'
                    }]
                },
                options: {
                    responsive: true,
                    scales: {
                        y: {
                            beginAtZero: true,
                            max: 100
                        }
                    }
                }
            });
        }

        // ======================
        // –í—Å–ø–æ–º–æ–≥–∞—Ç–µ–ª—å–Ω—ã–µ —Ñ—É–Ω–∫—Ü–∏–∏
        // ======================

        async function fetchWithRetry(url, retries = 3, delay = 1000) {
            try {
                const response = await fetch(url, {
                    method: "GET",
                    headers: { "Referrer-Policy": "no-referrer" },
                    mode: 'cors',
                    credentials: 'same-origin'
                });
                
                if (!response.ok) throw new Error(`HTTP error! status: ${response.status}`);
                return response;
            } catch (error) {
                if (retries > 0) {
                    await new Promise(resolve => setTimeout(resolve, delay));
                    return fetchWithRetry(url, retries - 1, delay * 2);
                }
                throw error;
            }
        }
        
        function showError(message) {
            Swal.fire({
                icon: 'error',
                title: '–û—à–∏–±–∫–∞',
                text: message,
                confirmButtonText: 'OK'
            });
        }
    </script>
</body>
</html>
