<!DOCTYPE html>
<html lang="ru" data-bs-theme="dark">
<head>
    <meta charset="UTF-8">
    <meta name="referrer" content="no-referrer">
    <meta name="description" content="–ö–∞—Ä—Ç–∞ –∏ —Å–ø–∏—Å–æ–∫ —Å–µ—Ä–≤–µ—Ä–æ–≤ ProtonVPN —Å –ø–æ–¥–¥–µ—Ä–∂–∫–æ–π IPv6">
    <meta http-equiv="Content-Security-Policy" content="
        default-src 'self' https://github.com; 
        script-src 'self' https://cdn.jsdelivr.net https://unpkg.com https://api.cors.lol 'unsafe-inline' https://cdn.datatables.net; 
        style-src 'self' https://cdn.jsdelivr.net https://unpkg.com 'unsafe-inline' https://cdn.datatables.net; 
        img-src 'self' data: https://tile.openstreetmap.org https://unpkg.com; 
        connect-src 'self' https://api.cors.lol https://api.protonmail.ch https://protonvpnmapproxy.privacyjam.com https://raw.githubusercontent.com https://cdn.datatables.net; 
        object-src 'none';">
    <meta http-equiv="Strict-Transport-Security" content="max-age=31536000; includeSubDomains; preload">
    <meta http-equiv="X-Content-Type-Options" content="nosniff">

    <title>ProtonVPN - –ö–∞—Ä—Ç–∞ –∏ —Å–ø–∏—Å–æ–∫ —Å–µ—Ä–≤–µ—Ä–æ–≤</title>
    
    <!-- Bootstrap –∏ DataTables -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css">
    <link rel="stylesheet" href="https://cdn.datatables.net/2.2.0/css/dataTables.bootstrap5.min.css"/>
    
    <!-- Leaflet –¥–ª—è –∫–∞—Ä—Ç—ã -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" crossorigin="">
    <link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster/dist/MarkerCluster.css" crossorigin="">
    <link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster/dist/MarkerCluster.Default.css" crossorigin="">

    <style>
        #map { 
            height: 60vh; 
            width: 100%; 
            margin-bottom: 20px;
            border-radius: 8px;
        }
        .popup-content {
            max-height: 200px;
            overflow-y: auto;
            width: 320px;
            white-space: nowrap;
        }
        #loading {
            position: absolute;
            top: 10px;
            left: 50%;
            transform: translateX(-50%);
            background: rgba(0, 0, 0, 0.7);
            color: white;
            padding: 8px 12px;
            border-radius: 5px;
            font-size: 14px;
            z-index: 1000;
        }
        .github-link {
            position: fixed;
            bottom: 40px;
            left: 20px;
            font-size: 14px;
            background: rgba(0, 0, 0, 0.8);
            padding: 8px 12px;
            border-radius: 8px;
            z-index: 1100;
        }
        .github-link a {
            color: white;
            text-decoration: none;
            font-weight: bold;
        }
        .nav-tabs {
            margin-bottom: 20px;
        }
        .tab-content {
            padding: 15px;
            border-left: 1px solid #444;
            border-right: 1px solid #444;
            border-bottom: 1px solid #444;
            border-radius: 0 0 8px 8px;
        }
        .last-update {
            position: fixed;
            top: 0;
            left: 0;
            background: rgba(0, 0, 0, 0.7);
            padding: 5px 10px;
            border-radius: 0 0 5px 0;
            z-index: 1000;
        }
    </style>
</head>
<body>
    <div class="container-fluid mt-3">
        <h1 class="text-center">ProtonVPN - –°–µ—Ä–≤–µ—Ä—ã –∏ –∫–∞—Ä—Ç–∞</h1>
        
        <ul class="nav nav-tabs" id="myTab" role="tablist">
            <li class="nav-item" role="presentation">
                <button class="nav-link active" id="map-tab" data-bs-toggle="tab" data-bs-target="#map-tab-pane" type="button" role="tab">–ö–∞—Ä—Ç–∞ —Å–µ—Ä–≤–µ—Ä–æ–≤</button>
            </li>
            <li class="nav-item" role="presentation">
                <button class="nav-link" id="list-tab" data-bs-toggle="tab" data-bs-target="#list-tab-pane" type="button" role="tab">–°–ø–∏—Å–æ–∫ —Å–µ—Ä–≤–µ—Ä–æ–≤</button>
            </li>
        </ul>
        
        <div class="tab-content" id="myTabContent">
            <div class="tab-pane fade show active" id="map-tab-pane" role="tabpanel" tabindex="0">
                <div id="map"></div>
                <div id="loading">–ó–∞–≥—Ä—É–∑–∫–∞ –¥–∞–Ω–Ω—ã—Ö –æ —Å–µ—Ä–≤–µ—Ä–∞—Ö...</div>
            </div>
            
            <div class="tab-pane fade" id="list-tab-pane" role="tabpanel" tabindex="0">
                <table id="server-table" class="table table-striped table-hover table-responsive table-sm">
                    <thead>
                        <tr>
                            <th>–£–∑–µ–ª</th>
                            <th>–°–µ—Ä–≤–µ—Ä</th>
                            <th>–í—Ö–æ–¥–Ω–æ–π IPv4</th>
                            <th>–í—ã—Ö–æ–¥–Ω–æ–π IPv4</th>
                            <th>–í—Ö–æ–¥–Ω–æ–π IPv6</th>
                            <th>–í—ã—Ö–æ–¥–Ω–æ–π IPv6 (–ø—Ä–µ–¥–ø–æ–ª–∞–≥–∞–µ–º—ã–π)</th>
                            <th>–ü—Ä–æ–≤–∞–π–¥–µ—Ä</th>
                        </tr>
                    </thead>
                </table>
            </div>
        </div>
    </div>
    
    <div class="github-link">
        <a href="https://github.com/privacyjam/Proton-Vpn-Server-Map" target="_blank">üåç –ü—Ä–æ—Å–º–æ—Ç—Ä–µ—Ç—å –Ω–∞ GitHub</a>
    </div>
    
    <div class="last-update">–ü–æ—Å–ª–µ–¥–Ω–µ–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ: 2025-02-26</div>

    <!-- –°–∫—Ä–∏–ø—Ç—ã -->
    <script src="https://cdn.jsdelivr.net/npm/jquery@3.7.1/dist/jquery.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://cdn.datatables.net/2.1.8/js/dataTables.js"></script>
    <script src="https://cdn.datatables.net/2.2.0/js/dataTables.bootstrap5.min.js"></script>
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js" crossorigin=""></script>
    <script src="https://unpkg.com/leaflet.markercluster/dist/leaflet.markercluster.js" crossorigin=""></script>
    <script src="https://cdn.jsdelivr.net/npm/jquery-csv@1.0.40/src/jquery.csv.min.js"></script>

     <script>
        // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è DataTables –∫–∞–∫ –≥–ª–æ–±–∞–ª—å–Ω–æ–π –ø–µ—Ä–µ–º–µ–Ω–Ω–æ–π
        $.fn.DataTable = $.fn.dataTable;
        
        // –õ–æ–∫–∞–ª–∏–∑–∞—Ü–∏—è DataTables –Ω–∞ —Ä—É—Å—Å–∫–∏–π
        const russianLanguage = {
            "decimal":        "",
            "emptyTable":     "–ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö –≤ —Ç–∞–±–ª–∏—Ü–µ",
            "info":           "–ü–æ–∫–∞–∑–∞–Ω–æ —Å _START_ –ø–æ _END_ –∏–∑ _TOTAL_ –∑–∞–ø–∏—Å–µ–π",
            "infoEmpty":      "–ü–æ–∫–∞–∑–∞–Ω–æ —Å 0 –ø–æ 0 –∏–∑ 0 –∑–∞–ø–∏—Å–µ–π",
            "infoFiltered":   "(–æ—Ç—Ñ–∏–ª—å—Ç—Ä–æ–≤–∞–Ω–æ –∏–∑ _MAX_ –∑–∞–ø–∏—Å–µ–π)",
            "infoPostFix":    "",
            "thousands":      ",",
            "lengthMenu":     "–ü–æ–∫–∞–∑–∞—Ç—å _MENU_ –∑–∞–ø–∏—Å–µ–π",
            "loadingRecords": "–ó–∞–≥—Ä—É–∑–∫–∞...",
            "processing":     "–û–±—Ä–∞–±–æ—Ç–∫–∞...",
            "search":         "–ü–æ–∏—Å–∫:",
            "zeroRecords":    "–°–æ–≤–ø–∞–¥–µ–Ω–∏–π –Ω–µ –Ω–∞–π–¥–µ–Ω–æ",
            "paginate": {
                "first":      "–ü–µ—Ä–≤–∞—è",
                "last":       "–ü–æ—Å–ª–µ–¥–Ω—è—è",
                "next":       "–°–ª–µ–¥—É—é—â–∞—è",
                "previous":   "–ü—Ä–µ–¥—ã–¥—É—â–∞—è"
            },
            "aria": {
                "sortAscending":  ": –∞–∫—Ç–∏–≤–∏—Ä–æ–≤–∞—Ç—å –¥–ª—è —Å–æ—Ä—Ç–∏—Ä–æ–≤–∫–∏ –ø–æ –≤–æ–∑—Ä–∞—Å—Ç–∞–Ω–∏—é",
                "sortDescending": ": –∞–∫—Ç–∏–≤–∏—Ä–æ–≤–∞—Ç—å –¥–ª—è —Å–æ—Ä—Ç–∏—Ä–æ–≤–∫–∏ –ø–æ —É–±—ã–≤–∞–Ω–∏—é"
            }
        };
        
        $(document).ready(async function() {
            // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –≤–∫–ª–∞–¥–æ–∫
            const tabEl = document.querySelector('button[data-bs-toggle="tab"]');
            if (tabEl) {
                tabEl.addEventListener('shown.bs.tab', function (event) {
                    if (event.target.id === 'map-tab' && !window.mapInitialized) {
                        initMap();
                        window.mapInitialized = true;
                    }
                });
            }

            // –ó–∞–≥—Ä—É–∂–∞–µ–º –¥–∞–Ω–Ω—ã–µ –¥–ª—è —Ç–∞–±–ª–∏—Ü—ã
            await loadServerTableData();
            
            // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä—É–µ–º –∫–∞—Ä—Ç—É, –µ—Å–ª–∏ –∞–∫—Ç–∏–≤–Ω–∞ –≤–∫–ª–∞–¥–∫–∞ —Å –∫–∞—Ä—Ç–æ–π
            if ($('#map-tab').hasClass('active')) {
                initMap();
                window.mapInitialized = true;
            }
        });

        async function loadServerTableData() {
            const MSG_UNKNOWN_IPV6 = ":: (–ï—Å—Ç—å, –Ω–æ –Ω–µ–∏–∑–≤–µ—Å—Ç–µ–Ω)";
            
            try {
                const [logicalsRes, nodesIpv6Res, ipinfoRes] = await Promise.all([
                    fetch("logicals.json?2025-01-21"),
                    fetch("nodes-ipv6.json?2025-01-21"),
                    fetch("ipinfo.csv?2025-01-21")
                ]);
                
                const [logicalsJson, nodesIpv6, ipinfoText] = await Promise.all([
                    logicalsRes.json(),
                    nodesIpv6Res.json(),
                    ipinfoRes.text()
                ]);
                
                const logicals = logicalsJson.LogicalServers;
                const ipinfo = $.csv.toObjects(ipinfoText);
                const data = [];

                logicals.filter(l => l.Servers.length === 1).forEach(logical => {
                    const isp = ipinfo.find(i => i.ip === logical.Servers[0].ExitIP);
                    data.push([
                        logical.Domain,
                        logical.Name,
                        logical.Servers[0].EntryIP,
                        logical.Servers[0].ExitIP,
                        nodesIpv6[logical.Domain] || (!!(16 & logical.Features) ? MSG_UNKNOWN_IPV6 : ""),
                        "", // –í—ã—Ö–æ–¥–Ω–æ–π IPv6 –±—É–¥–µ—Ç –∑–∞–ø–æ–ª–Ω–µ–Ω –ø–æ–∑–∂–µ
                        isp ? isp.org : ""
                    ]);
                });

                // –ü—Ä–µ–¥–ø–æ–ª–∞–≥–∞–µ–º –≤—ã—Ö–æ–¥–Ω—ã–µ IPv6 –∞–¥—Ä–µ—Å–∞
                const hasIpv6 = data.filter(l => l[4] !== "" && l[4] !== MSG_UNKNOWN_IPV6);
                hasIpv6.sort((a, b) => Number(a[1].split("#")[1]) - Number(b[1].split("#")[1]));

                Object.entries(Object.groupBy(hasIpv6, d => d[0])).forEach(([_, node]) => {
                    const parts = node[0][4].split("::");
                    const prefix = parts[0];
                    let suffixInt = parseInt(parts[1], 16);

                    // –ò—Å–ø—Ä–∞–≤–ª–µ–Ω–∏—è –¥–ª—è —Å–ø–µ—Ü–∏—Ñ–∏—á–µ—Å–∫–∏—Ö —Å–ª—É—á–∞–µ–≤
                    if (suffixInt === 17) suffixInt = 16;
                    if (suffixInt === 13) suffixInt = 32;
                    
                    node.forEach(server => {
                        suffixInt++;
                        server[5] = `${prefix}::${suffixInt.toString(16)}`;
                    });
                });

                // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è —Ç–∞–±–ª–∏—Ü—ã
                $('#server-table').DataTable({
                    data: data,
                    pageLength: 25,
                    language: russianLanguage,
                    search: {
                        search: '::'
                    }
                });
            } catch (error) {
                console.error("–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –¥–∞–Ω–Ω—ã—Ö –¥–ª—è —Ç–∞–±–ª–∏—Ü—ã:", error);
            }
        }

        function initMap() {
            const map = L.map('map', { 
                center: [20, 0], 
                zoom: 2, 
                zoomSnap: 0.5
            });
    
            L.tileLayer('https://tile.openstreetmap.org/{z}/{x}/{y}.png', {
                maxZoom: 19,
                attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a>'
            }).addTo(map);
    
            const markerCluster = L.markerClusterGroup({
                maxClusterRadius: 20,
                disableClusteringAtZoom: 8,
                iconCreateFunction: (cluster) => {
                    const childCount = cluster.getChildCount();
                    let clusterClass = 'marker-cluster-small';
                    if (childCount > 10) clusterClass = 'marker-cluster-medium';
                    if (childCount > 50) clusterClass = 'marker-cluster-large';
                    return new L.DivIcon({
                        html: `<div><span>${childCount}</span></div>`,
                        className: `marker-cluster ${clusterClass}`,
                        iconSize: [30, 30],
                    });
                },
            });            
    
            const defaultIcon = L.icon({
                iconUrl: 'https://unpkg.com/leaflet@1.9.4/dist/images/marker-icon.png',
                shadowUrl: 'https://unpkg.com/leaflet@1.9.4/dist/images/marker-shadow.png',
                iconSize: [25, 41],
                iconAnchor: [12, 41],
                popupAnchor: [1, -34],
                shadowSize: [41, 41]
            });
    
            async function fetchData() {
                const urls = [
                    "https://protonvpnmapproxy.privacyjam.com",
                    "https://protonvpnmap.privacyjam.com/backup_logicals.json",
                    "logicals.json?2025-01-21"
                ];
    
                for (let url of urls) {
                    try {
                        const response = await fetch(url, {
                            method: "GET",
                            headers: { "Referrer-Policy": "no-referrer" },
                            mode: 'cors'
                        });
                        if (response.ok) {
                            return await response.json();
                        }
                    } catch (error) {
                        console.warn(`–ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–≥—Ä—É–∑–∏—Ç—å –¥–∞–Ω–Ω—ã–µ –∏–∑ ${url}:`, error);
                    }
                }
                throw new Error("–í—Å–µ –∏—Å—Ç–æ—á–Ω–∏–∫–∏ –¥–∞–Ω–Ω—ã—Ö –Ω–µ–¥–æ—Å—Ç—É–ø–Ω—ã.");
            }
    
            fetchData().then(data => {
                document.getElementById("loading").style.display = "none";
    
                if (!data.LogicalServers) throw new Error("–ù–µ–≤–µ—Ä–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ");
    
                const locationGroups = {};
    
                data.LogicalServers.forEach(server => {
                    if (server.Location && server.Location.Lat && server.Location.Long) {
                        const key = `${server.Location.Lat.toFixed(2)},${server.Location.Long.toFixed(2)}`;
                        if (!locationGroups[key]) {
                            locationGroups[key] = [];
                        }
                        locationGroups[key].push(server);
                    }
                });
    
                Object.entries(locationGroups).forEach(([key, servers]) => {
                    const [lat, lon] = key.split(',').map(Number);
                    const locationName = servers[0].City ? servers[0].City : servers[0].EntryCountry;
    
                    let popupContent = `<b>${locationName}</b><br>`;
                    popupContent += `<b>${servers.length} —Å–µ—Ä–≤–µ—Ä–æ–≤</b><br><div class="popup-content">`;
    
                    servers.forEach(server => {
                        let smartRouting = server.HostCountry && server.HostCountry !== server.EntryCountry 
                            ? `<span style="color:red; font-weight:bold;">(Smart Routing –∏–∑ ${server.HostCountry})</span>` 
                            : '';
    
                        let torServer = server.Name.includes("TOR") 
                            ? `<span style="color:purple; font-weight:bold;">(TOR —Å–µ—Ä–≤–µ—Ä)</span>` 
                            : '';
                        
                        let secureCore = (server.Features === 1 && server.EntryCountry !== server.ExitCountry) 
                            ? `<span style="color:orange; font-weight:bold;">(Secure Core –∏–∑ ${server.EntryCountry})</span>` 
                            : (server.Features === 1) 
                                ? `<span style="color:orange; font-weight:bold;">(Secure Core —Å–µ—Ä–≤–µ—Ä)</span>` 
                                : '';
                        
                        popupContent += `üîπ <b>${server.Name}</b> - –ù–∞–≥—Ä—É–∑–∫–∞: ${server.Load}% ${smartRouting} ${torServer} ${secureCore}<br>`;
                    });
    
                    popupContent += `</div>`;
    
                    const marker = L.marker([lat, lon], { icon: defaultIcon })
                        .bindPopup(popupContent, { maxWidth: 350 });
    
                    markerCluster.addLayer(marker);
                });
    
                map.addLayer(markerCluster);
            }).catch(error => {
                document.getElementById("loading").textContent = "–ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–≥—Ä—É–∑–∏—Ç—å –¥–∞–Ω–Ω—ã–µ –æ —Å–µ—Ä–≤–µ—Ä–∞—Ö VPN.";
                console.error("–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –¥–∞–Ω–Ω—ã—Ö VPN:", error);
            });
        }
    </script>
</body>
</html>
